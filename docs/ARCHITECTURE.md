# UnPass 密码管理器架构设计文档

## 1. 架构概述

UnPass 是一个基于现代 Android 架构组件构建的安全密码管理器应用。本应用采用模块化、分层架构设计，确保代码的可维护性、可测试性和可扩展性。

### 1.1 核心设计原则

- **安全第一**: 所有数据加密存储，采用多层安全防护
- **模块化设计**: 功能模块独立，依赖关系清晰
- **Clean Architecture**: 分层架构，业务逻辑与UI解耦
- **现代技术栈**: 使用最新的Android开发工具和库
- **测试驱动**: 高测试覆盖率，确保代码质量

### 1.2 架构层次

```
┌─────────────────────────────────────────────────────────────┐
│                    表现层 (Presentation)                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  Compose UI │  │  ViewModel  │  │  Navigation │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                    业务逻辑层 (Domain)                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  Use Cases  │  │  Repository │  │   Entities  │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                     数据层 (Data)                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  Database   │  │  Security   │  │   Crypto    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

## 2. 模块结构设计

### 2.1 模块依赖关系

```
                    ┌──────────────┐
                    │     app      │
                    └──────┬───────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
   ┌────▼─────┐      ┌─────▼─────┐      ┌────▼─────┐
   │feature-  │      │feature-   │      │feature-  │
   │auth      │      │vault      │      │settings  │
   └────┬─────┘      └─────┬─────┘      └────┬─────┘
        │                  │                  │
        └──────────────────┼──────────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
   ┌────▼─────┐      ┌─────▼─────┐      ┌────▼─────┐
   │core-     │      │core-      │      │core-     │
   │security  │      │database   │      │crypto    │
   └──────────┘      └───────────┘      └──────────┘
                           │
                    ┌──────▼───────┐
                    │   core-ui    │
                    └──────────────┘
```

### 2.2 模块职责

#### 2.2.1 应用模块 (app)
- **职责**: 应用入口点，依赖注入配置，全局导航
- **关键组件**:
  - `MainActivity`: 主活动，承载所有Fragment
  - `UnPassApplication`: 应用类，Hilt初始化
  - `AppNavigation`: 全局导航配置
  - `AppModule`: 应用级依赖注入模块

#### 2.2.2 核心模块

##### core-security
- **职责**: 提供安全相关功能，生物识别认证
- **关键组件**:
  - `BiometricManager`: 生物识别管理
  - `KeystoreManager`: Android Keystore管理
  - `SecurityConfig`: 安全配置常量
  - `AuthenticationManager`: 认证管理器

##### core-database
- **职责**: 数据库操作，数据持久化
- **关键组件**:
  - `UnPassDatabase`: Room数据库
  - `PasswordDao`: 密码数据访问对象
  - `CategoryDao`: 分类数据访问对象
  - `DatabaseMigrations`: 数据库迁移
  - `DatabaseModule`: 数据库依赖注入

##### core-crypto
- **职责**: 加密解密，密钥管理
- **关键组件**:
  - `CryptoManager`: 加密管理器
  - `KeyDerivation`: 密钥派生算法
  - `SymmetricCrypto`: 对称加密
  - `PasswordGenerator`: 密码生成器

##### core-ui
- **职责**: 通用UI组件，主题设计
- **关键组件**:
  - `UnPassTheme`: 应用主题
  - `CommonComponents`: 通用组件
  - `Icons`: 图标资源
  - `Colors`: 颜色定义

#### 2.2.3 功能模块

##### feature-auth
- **职责**: 用户认证，主密码管理
- **关键组件**:
  - `LoginScreen`: 登录界面
  - `SetupScreen`: 初始设置界面
  - `AuthViewModel`: 认证视图模型
  - `AuthRepository`: 认证仓库

##### feature-vault
- **职责**: 密码库管理，密码CRUD操作
- **关键组件**:
  - `VaultScreen`: 密码库界面
  - `PasswordDetailScreen`: 密码详情界面
  - `VaultViewModel`: 密码库视图模型
  - `PasswordRepository`: 密码仓库

##### feature-settings
- **职责**: 应用设置，偏好管理
- **关键组件**:
  - `SettingsScreen`: 设置界面
  - `SettingsViewModel`: 设置视图模型
  - `PreferencesRepository`: 偏好仓库

##### feature-export
- **职责**: 数据导入导出功能
- **关键组件**:
  - `ExportScreen`: 导出界面
  - `ImportScreen`: 导入界面
  - `ExportViewModel`: 导出视图模型
  - `DataExporter`: 数据导出器

## 3. 数据流架构

### 3.1 MVVM + Repository 模式

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Screen    │───▶│  ViewModel  │───▶│ Repository  │
│  (Compose)  │    │             │    │             │
└─────────────┘    └─────────────┘    └─────────────┘
       ▲                   ▲                   │
       │                   │                   ▼
       └───── State ────────┘         ┌─────────────┐
                                      │ Data Source │
                                      │(Database/   │
                                      │ Network)    │
                                      └─────────────┘
```

### 3.2 状态管理

- **StateFlow**: 用于状态管理，响应式编程
- **LiveData**: 生命周期感知的数据观察
- **Compose State**: UI状态管理

## 4. 安全架构设计

### 4.1 多层安全防护

```
┌─────────────────────────────────────────────────────────────┐
│                     应用层安全                                │
│  - 生物识别认证                                               │
│  - 主密码验证                                                 │
│  - 自动锁定                                                   │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                     数据层安全                                │
│  - AES-256加密                                               │
│  - 密钥派生 (PBKDF2)                                         │
│  - 数据库加密 (SQLCipher)                                    │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                     系统层安全                                │
│  - Android Keystore                                         │
│  - 硬件安全模块 (HSM)                                        │
│  - 应用签名验证                                               │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 密钥管理策略

1. **主密钥 (Master Key)**
   - 用户设置的主密码
   - 通过PBKDF2进行密钥派生
   - 存储在Android Keystore中

2. **数据库密钥 (Database Key)**
   - 用于SQLCipher数据库加密
   - 由主密钥派生生成
   - 内存中处理，不持久化

3. **字段加密密钥 (Field Encryption Key)**
   - 用于敏感字段额外加密
   - 定期轮换
   - 硬件安全模块保护

## 5. 技术栈选择

### 5.1 UI层
- **Jetpack Compose**: 现代声明式UI框架
- **Material 3**: 最新设计系统
- **Navigation Compose**: 导航组件

### 5.2 架构组件
- **ViewModel**: 视图模型，处理UI逻辑
- **LiveData/StateFlow**: 数据观察和状态管理
- **Room**: 数据库ORM框架
- **Hilt**: 依赖注入框架

### 5.3 安全组件
- **Biometric**: 生物识别认证
- **Security Crypto**: 加密操作
- **SQLCipher**: 数据库加密
- **Bouncy Castle**: 加密算法库

### 5.4 测试框架
- **JUnit**: 单元测试
- **Mockk**: Kotlin模拟框架
- **Espresso**: UI测试
- **Truth**: 断言库

## 6. 性能优化策略

### 6.1 内存管理
- 使用弱引用避免内存泄漏
- 及时清理敏感数据
- 优化数据库查询

### 6.2 启动优化
- 延迟初始化非关键组件
- 使用SplashScreen API
- 预加载关键数据

### 6.3 电池优化
- 合理使用后台任务
- 优化网络请求
- 使用JobScheduler管理任务

## 7. 测试策略

### 7.1 测试金字塔

```
        ┌─────────────┐
        │   UI Tests  │  (10%)
        │  (Espresso) │
        └─────────────┘
      ┌─────────────────┐
      │ Integration     │  (20%)
      │ Tests           │
      └─────────────────┘
    ┌─────────────────────┐
    │   Unit Tests        │  (70%)
    │  (JUnit + Mockk)   │
    └─────────────────────┘
```

### 7.2 测试分层

1. **单元测试**: 业务逻辑、工具类
2. **集成测试**: 模块间交互
3. **UI测试**: 用户界面流程
4. **安全测试**: 加密解密、认证

## 8. 部署和发布

### 8.1 构建配置
- **Debug**: 开发调试版本
- **Release**: 生产发布版本
- **ProGuard**: 代码混淆和优化

### 8.2 CI/CD流程
- 自动化测试
- 代码质量检查
- 安全扫描
- 自动发布

## 9. 监控和日志

### 9.1 性能监控
- 应用启动时间
- 内存使用情况
- 网络请求性能
- 崩溃率监控

### 9.2 安全监控
- 异常登录尝试
- 数据访问日志
- 加密操作记录
- 安全事件告警

## 10. 未来扩展

### 10.1 功能扩展
- 云同步功能
- 多设备支持
- 企业版功能
- 浏览器扩展

### 10.2 技术升级
- Kotlin Multiplatform
- Compose Multiplatform
- 新的安全标准
- 人工智能集成

---

*本文档将随着项目发展持续更新，确保架构设计与实际实现保持一致。* 